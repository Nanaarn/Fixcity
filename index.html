<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixMaCity - Am√©liorons nos villes ensemble</title>
    <meta name="description" content="Signalez les probl√®mes de votre ville, votez, aidez √† r√©soudre. Ensemble, am√©liorons nos quartiers.">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LEAFLET - 100% GRATUIT, PAS DE CARTE BANCAIRE -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        #map { height: 600px; width: 100%; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Header -->
    <nav class="gradient-bg shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3 cursor-pointer" id="logo">
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                        <span class="text-2xl">üèôÔ∏è</span>
                    </div>
                    <h1 class="text-2xl font-black text-white">FixMaCity</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="my-problems-btn" class="text-white hover:text-purple-200 transition-all font-semibold hidden">
                        Mes probl√®mes
                    </button>
                    <button id="leaderboard-btn" class="text-white hover:text-purple-200 transition-all font-semibold">
                        üèÜ Classement
                    </button>
                    <button id="add-problem-btn" class="bg-white text-purple-700 px-6 py-2 rounded-xl font-bold hover:shadow-lg transition-all">
                        ‚ûï Signaler (1‚Ç¨)
                    </button>
                    <div id="user-avatar" class="w-10 h-10 bg-white rounded-full flex items-center justify-center cursor-pointer">
                        <span class="text-xl">üë§</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Landing Page -->
        <div id="landing-page">
            <div class="text-center mb-12">
                <h2 class="text-5xl font-black text-gray-900 mb-4">
                    Am√©liorons nos villes<br/>
                    <span class="gradient-bg bg-clip-text text-transparent">ensemble</span> üåÜ
                </h2>
                <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">
                    Signalez les probl√®mes de votre quartier. Votez pour prioriser. Aidez √† r√©soudre. 
                    Ensemble, rendons nos villes meilleures.
                </p>
                <button id="start-btn" class="gradient-bg text-white px-12 py-4 rounded-2xl font-bold text-xl hover:shadow-2xl transition-all">
                    üöÄ Commencer
                </button>
            </div>

            <div class="grid md:grid-cols-3 gap-8 mb-16">
                <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                    <div class="text-5xl mb-4">üìç</div>
                    <h3 class="text-xl font-bold mb-3">Signalez</h3>
                    <p class="text-gray-600">Un nid de poule ? Un graffiti ? Une poubelle qui d√©borde ? Signalez en 1 clic.</p>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                    <div class="text-5xl mb-4">üëç</div>
                    <h3 class="text-xl font-bold mb-3">Votez</h3>
                    <p class="text-gray-600">Les probl√®mes les plus vot√©s sont trait√©s en priorit√© par la communaut√©.</p>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-lg text-center">
                    <div class="text-5xl mb-4">‚úÖ</div>
                    <h3 class="text-xl font-bold mb-3">R√©solvez</h3>
                    <p class="text-gray-600">Aidez physiquement, suivez avec la mairie, ou contribuez financi√®rement.</p>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            
            <!-- User Stats Bar -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8 flex justify-between items-center">
                <div>
                    <h3 class="text-2xl font-black text-gray-900 mb-1">Bonjour, <span id="user-name">Citoyen</span> üëã</h3>
                    <p class="text-gray-600">Continuez √† am√©liorer votre ville !</p>
                </div>
                <div class="flex gap-6">
                    <div class="text-center">
                        <div class="text-3xl font-black text-purple-600" id="user-points">0</div>
                        <div class="text-sm text-gray-600">Points</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-black text-pink-600" id="user-problems">0</div>
                        <div class="text-sm text-gray-600">Probl√®mes</div>
                    </div>
                    <div class="text-center">
                        <div class="text-3xl font-black text-orange-600" id="user-resolved">0</div>
                        <div class="text-sm text-gray-600">R√©solus</div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex gap-4 flex-wrap">
                    <button class="filter-btn active px-6 py-2 rounded-xl font-bold transition-all" data-filter="all">
                        Tous
                    </button>
                    <button class="filter-btn px-6 py-2 rounded-xl font-bold transition-all" data-filter="voirie">
                        üõ£Ô∏è Voirie
                    </button>
                    <button class="filter-btn px-6 py-2 rounded-xl font-bold transition-all" data-filter="proprete">
                        üóëÔ∏è Propret√©
                    </button>
                    <button class="filter-btn px-6 py-2 rounded-xl font-bold transition-all" data-filter="securite">
                        üö® S√©curit√©
                    </button>
                    <button class="filter-btn px-6 py-2 rounded-xl font-bold transition-all" data-filter="nature">
                        üå≥ Nature
                    </button>
                    <button class="filter-btn px-6 py-2 rounded-xl font-bold transition-all" data-filter="autre">
                        ‚ö° Autre
                    </button>
                </div>
            </div>

            <!-- Map -->
            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <h3 class="text-2xl font-bold mb-4">üìç Carte des probl√®mes</h3>
                <div id="map" class="rounded-xl overflow-hidden"></div>
            </div>

            <!-- Problems List -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-6">üî• Probl√®mes prioritaires</h3>
                <div id="problems-list" class="space-y-4"></div>
            </div>
        </div>

        <!-- Leaderboard Page -->
        <div id="leaderboard-page" class="hidden">
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h2 class="text-3xl font-black mb-6 text-center">üèÜ Top Citoyens</h2>
                <div id="leaderboard-list" class="space-y-4"></div>
            </div>
        </div>

    </div>

    <!-- Add Problem Modal -->
    <div id="add-problem-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-black">‚ûï Signaler un probl√®me</h3>
                    <button id="close-modal" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">‚úï</button>
                </div>

                <form id="problem-form">
                    <div class="mb-6">
                        <label class="block font-bold mb-3">Cat√©gorie</label>
                        <select id="problem-category" class="w-full border-2 border-gray-200 rounded-xl p-4 focus:border-purple-600 focus:outline-none" required>
                            <option value="">Choisir une cat√©gorie</option>
                            <option value="voirie">üõ£Ô∏è Voirie (nid de poule, trottoir cass√©...)</option>
                            <option value="proprete">üóëÔ∏è Propret√© (poubelle, d√©tritus...)</option>
                            <option value="securite">üö® S√©curit√© (√©clairage, danger...)</option>
                            <option value="nature">üå≥ Nature (arbre dangereux, espace vert...)</option>
                            <option value="autre">‚ö° Autre</option>
                        </select>
                    </div>

                    <div class="mb-6">
                        <label class="block font-bold mb-3">Description</label>
                        <textarea id="problem-description" rows="4" class="w-full border-2 border-gray-200 rounded-xl p-4 focus:border-purple-600 focus:outline-none" placeholder="D√©crivez le probl√®me..." required></textarea>
                    </div>

                    <div class="mb-6">
                        <label class="block font-bold mb-3">üìç Localisation</label>
                        <input type="text" id="problem-address" class="w-full border-2 border-gray-200 rounded-xl p-4 focus:border-purple-600 focus:outline-none mb-4" placeholder="Entrez une adresse...">
                        <div id="mini-map" style="height: 300px;" class="rounded-xl overflow-hidden"></div>
                        <p class="text-sm text-gray-600 mt-2">Cliquez sur la carte pour placer le marqueur pr√©cis√©ment</p>
                    </div>

                    <div class="mb-6">
                        <label class="block font-bold mb-3">Photo (optionnel)</label>
                        <input type="file" id="problem-photo" accept="image/*" capture="environment" class="w-full border-2 border-gray-200 rounded-xl p-4">
                    </div>

                    <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-4 mb-6">
                        <p class="font-bold text-purple-900 mb-2">üí° Prix : 1‚Ç¨</p>
                        <p class="text-sm text-purple-700">Ce montant permet d'√©viter le spam et de garder une communaut√© de qualit√©.</p>
                    </div>

                    <button type="submit" class="w-full gradient-bg text-white py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition-all">
                        üí≥ Payer 1‚Ç¨ et Publier
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Problem Detail Modal -->
    <div id="problem-detail-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-white rounded-3xl max-w-3xl w-full my-8 shadow-2xl">
            <div id="problem-detail-content"></div>
        </div>
    </div>

    <script>
        // ==================== DATA STORAGE ====================
        
        const DB = {
            problems: JSON.parse(localStorage.getItem('fixmacity_problems') || '[]'),
            users: JSON.parse(localStorage.getItem('fixmacity_users') || '[]'),
            currentUser: JSON.parse(localStorage.getItem('fixmacity_currentUser') || 'null'),
            votes: JSON.parse(localStorage.getItem('fixmacity_votes') || '[]'),
            
            save() {
                localStorage.setItem('fixmacity_problems', JSON.stringify(this.problems));
                localStorage.setItem('fixmacity_users', JSON.stringify(this.users));
                localStorage.setItem('fixmacity_currentUser', JSON.stringify(this.currentUser));
                localStorage.setItem('fixmacity_votes', JSON.stringify(this.votes));
            },
            
            initDemo() {
                if (this.users.length === 0) {
                    this.users = [
                        { id: 1, name: 'Marie Dubois', points: 350, problemsPosted: 12, problemsResolved: 8 },
                        { id: 2, name: 'Thomas Martin', points: 280, problemsPosted: 8, problemsResolved: 6 },
                        { id: 3, name: 'Sophie Laurent', points: 420, problemsPosted: 15, problemsResolved: 10 }
                    ];
                }
                
                if (!this.currentUser) {
                    this.currentUser = { 
                        id: Date.now(), 
                        name: 'Vous', 
                        points: 0, 
                        problemsPosted: 0, 
                        problemsResolved: 0 
                    };
                    this.users.push(this.currentUser);
                }
                
                if (this.problems.length === 0) {
                    this.problems = [
                        {
                            id: 1,
                            category: 'voirie',
                            description: 'Nid de poule dangereux sur Avenue des Champs',
                            address: '75 Avenue des Champs-√âlys√©es, Paris',
                            lat: 48.8698,
                            lng: 2.3078,
                            photo: 'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400',
                            userId: 1,
                            status: 'signale',
                            votes: 45,
                            timestamp: Date.now() - 2*24*60*60*1000,
                            comments: []
                        },
                        {
                            id: 2,
                            category: 'proprete',
                            description: 'Poubelle d√©bordante jamais ramass√©e',
                            address: 'Rue de Rivoli, Paris',
                            lat: 48.8606,
                            lng: 2.3376,
                            photo: 'https://images.unsplash.com/photo-1604187351574-c75ca79f5807?w=400',
                            userId: 2,
                            status: 'en_cours',
                            votes: 32,
                            timestamp: Date.now() - 1*24*60*60*1000,
                            comments: []
                        }
                    ];
                }
                
                this.save();
            }
        };

        DB.initDemo();

        // ==================== APP STATE ====================
        
        const App = {
            map: null,
            miniMap: null,
            markers: [],
            selectedLocation: { lat: 48.8566, lng: 2.3522 }, // Paris par d√©faut
            currentFilter: 'all',
            
            init() {
                this.setupEventListeners();
                this.showLanding();
            },
            
            showLanding() {
                document.getElementById('landing-page').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('leaderboard-page').classList.add('hidden');
            },
            
            showMainApp() {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('leaderboard-page').classList.add('hidden');
                this.updateUserStats();
                this.initMap();
                this.renderProblems();
            },
            
            showLeaderboard() {
                document.getElementById('landing-page').classList.add('hidden');
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('leaderboard-page').classList.remove('hidden');
                this.renderLeaderboard();
            },
            
            updateUserStats() {
                const user = DB.currentUser;
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-points').textContent = user.points;
                document.getElementById('user-problems').textContent = user.problemsPosted;
                document.getElementById('user-resolved').textContent = user.problemsResolved;
            },
            
            initMap() {
                if (!this.map) {
                    this.map = new google.maps.Map(document.getElementById('map'), {
                        center: this.selectedLocation,
                        zoom: 13,
                        styles: [
                            { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }
                        ]
                    });
                }
                this.renderMapMarkers();
            },
            
            renderMapMarkers() {
                // Clear existing markers
                this.markers.forEach(marker => marker.setMap(null));
                this.markers = [];
                
                // Filter problems
                const filteredProblems = this.currentFilter === 'all' 
                    ? DB.problems 
                    : DB.problems.filter(p => p.category === this.currentFilter);
                
                // Add markers
                filteredProblems.forEach(problem => {
                    const marker = new google.maps.Marker({
                        position: { lat: problem.lat, lng: problem.lng },
                        map: this.map,
                        title: problem.description,
                        icon: {
                            url: this.getMarkerIcon(problem.category, problem.status),
                            scaledSize: new google.maps.Size(40, 40)
                        }
                    });
                    
                    marker.addListener('click', () => {
                        this.showProblemDetail(problem.id);
                    });
                    
                    this.markers.push(marker);
                });
            },
            
            getMarkerIcon(category, status) {
                const colors = {
                    voirie: 'blue',
                    proprete: 'green',
                    securite: 'red',
                    nature: 'green',
                    autre: 'gray'
                };
                const color = colors[category] || 'gray';
                const opacity = status === 'resolu' ? '0.5' : '1';
                return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Ccircle cx='20' cy='20' r='18' fill='${color}' opacity='${opacity}' stroke='white' stroke-width='2'/%3E%3C/svg%3E`;
            },
            
            renderProblems() {
                const container = document.getElementById('problems-list');
                const filteredProblems = this.currentFilter === 'all' 
                    ? DB.problems 
                    : DB.problems.filter(p => p.category === this.currentFilter);
                
                const sortedProblems = [...filteredProblems].sort((a, b) => b.votes - a.votes);
                
                container.innerHTML = sortedProblems.map(problem => {
                    const user = DB.users.find(u => u.id === problem.userId);
                    const hasVoted = DB.votes.some(v => v.userId === DB.currentUser.id && v.problemId === problem.id);
                    const statusLabels = {
                        signale: 'üî¥ Signal√©',
                        en_cours: 'üü° En cours',
                        resolu: 'üü¢ R√©solu'
                    };
                    
                    return `
                        <div class="border-2 border-gray-200 rounded-2xl p-6 hover:shadow-lg transition-all cursor-pointer" onclick="App.showProblemDetail(${problem.id})">
                            <div class="flex gap-6">
                                ${problem.photo ? `<img src="${problem.photo}" class="w-32 h-32 object-cover rounded-xl flex-shrink-0">` : ''}
                                <div class="flex-1">
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            <span class="inline-block px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-bold mb-2">
                                                ${this.getCategoryLabel(problem.category)}
                                            </span>
                                            <h4 class="text-xl font-bold text-gray-900">${problem.description}</h4>
                                            <p class="text-gray-600 text-sm mt-1">üìç ${problem.address}</p>
                                        </div>
                                        <span class="text-sm font-bold ${problem.status === 'resolu' ? 'text-green-600' : problem.status === 'en_cours' ? 'text-yellow-600' : 'text-red-600'}">
                                            ${statusLabels[problem.status]}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-6 mt-4">
                                        <button class="flex items-center gap-2 ${hasVoted ? 'text-purple-600' : 'text-gray-600'} hover:text-purple-600 transition-all" onclick="event.stopPropagation(); App.toggleVote(${problem.id})">
                                            <span class="text-2xl">${hasVoted ? 'üëç' : 'üëçüèª'}</span>
                                            <span class="font-bold text-lg">${problem.votes}</span>
                                        </button>
                                        <span class="text-gray-500 text-sm">Par ${user?.name || 'Anonyme'}</span>
                                        <span class="text-gray-500 text-sm">${this.formatDate(problem.timestamp)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            getCategoryLabel(category) {
                const labels = {
                    voirie: 'üõ£Ô∏è Voirie',
                    proprete: 'üóëÔ∏è Propret√©',
                    securite: 'üö® S√©curit√©',
                    nature: 'üå≥ Nature',
                    autre: '‚ö° Autre'
                };
                return labels[category] || category;
            },
            
            formatDate(timestamp) {
                const diff = Date.now() - timestamp;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                if (days === 0) return "Aujourd'hui";
                if (days === 1) return "Hier";
                return `Il y a ${days} jours`;
            },
            
            toggleVote(problemId) {
                const existingVote = DB.votes.findIndex(v => v.userId === DB.currentUser.id && v.problemId === problemId);
                const problem = DB.problems.find(p => p.id === problemId);
                
                if (existingVote >= 0) {
                    DB.votes.splice(existingVote, 1);
                    problem.votes--;
                } else {
                    DB.votes.push({ userId: DB.currentUser.id, problemId: problemId });
                    problem.votes++;
                    DB.currentUser.points += 5;
                }
                
                DB.save();
                this.renderProblems();
                this.updateUserStats();
            },
            
            showProblemDetail(problemId) {
                const problem = DB.problems.find(p => p.id === problemId);
                const user = DB.users.find(u => u.id === problem.userId);
                const hasVoted = DB.votes.some(v => v.userId === DB.currentUser.id && v.problemId === problem.id);
                const statusLabels = {
                    signale: 'üî¥ Signal√©',
                    en_cours: 'üü° En cours',
                    resolu: 'üü¢ R√©solu'
                };
                
                const content = `
                    <div class="p-8">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <span class="inline-block px-4 py-2 bg-purple-100 text-purple-700 rounded-full text-sm font-bold mb-3">
                                    ${this.getCategoryLabel(problem.category)}
                                </span>
                                <h2 class="text-3xl font-black text-gray-900 mb-2">${problem.description}</h2>
                                <p class="text-gray-600">üìç ${problem.address}</p>
                            </div>
                            <button onclick="App.closeProblemDetail()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">‚úï</button>
                        </div>
                        
                        ${problem.photo ? `<img src="${problem.photo}" class="w-full h-96 object-cover rounded-2xl mb-6">` : ''}
                        
                        <div class="flex items-center gap-6 mb-6">
                            <button class="flex items-center gap-3 px-6 py-3 ${hasVoted ? 'bg-purple-600 text-white' : 'bg-gray-100'} rounded-xl font-bold hover:shadow-lg transition-all" onclick="App.toggleVote(${problem.id}); App.showProblemDetail(${problem.id})">
                                <span class="text-2xl">üëç</span>
                                <span class="text-xl">${problem.votes} votes</span>
                            </button>
                            <span class="font-bold text-lg ${problem.status === 'resolu' ? 'text-green-600' : problem.status === 'en_cours' ? 'text-yellow-600' : 'text-red-600'}">
                                ${statusLabels[problem.status]}
                            </span>
                        </div>
                        
                        <div class="bg-gray-50 rounded-2xl p-6 mb-6">
                            <h3 class="font-bold text-lg mb-4">üí° Comment aider ?</h3>
                            <div class="grid md:grid-cols-3 gap-4">
                                <button class="bg-white p-4 rounded-xl hover:shadow-md transition-all">
                                    <div class="text-3xl mb-2">üîß</div>
                                    <div class="font-bold mb-1">Aider physiquement</div>
                                    <div class="text-sm text-gray-600">Je peux r√©soudre ce probl√®me</div>
                                </button>
                                <button class="bg-white p-4 rounded-xl hover:shadow-md transition-all">
                                    <div class="text-3xl mb-2">üìß</div>
                                    <div class="font-bold mb-1">Contacter la mairie</div>
                                    <div class="text-sm text-gray-600">Je g√®re le suivi administratif</div>
                                </button>
                                <button class="bg-white p-4 rounded-xl hover:shadow-md transition-all">
                                    <div class="text-3xl mb-2">üí∞</div>
                                    <div class="font-bold mb-1">Contribuer (5‚Ç¨)</div>
                                    <div class="text-sm text-gray-600">J'aide √† financer la solution</div>
                                </button>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-200 pt-6">
                            <p class="text-sm text-gray-600">Signal√© par <strong>${user?.name || 'Anonyme'}</strong> ‚Ä¢ ${this.formatDate(problem.timestamp)}</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('problem-detail-content').innerHTML = content;
                document.getElementById('problem-detail-modal').classList.remove('hidden');
            },
            
            closeProblemDetail() {
                document.getElementById('problem-detail-modal').classList.add('hidden');
            },
            
            renderLeaderboard() {
                const sortedUsers = [...DB.users].sort((a, b) => b.points - a.points);
                const container = document.getElementById('leaderboard-list');
                
                container.innerHTML = sortedUsers.map((user, index) => {
                    const badges = {
                        0: 'ü•á',
                        1: 'ü•à',
                        2: 'ü•â'
                    };
                    
                    return `
                        <div class="flex items-center justify-between p-6 ${index < 3 ? 'bg-gradient-to-r from-purple-50 to-pink-50' : 'bg-gray-50'} rounded-2xl">
                            <div class="flex items-center gap-4">
                                <span class="text-3xl font-black ${index < 3 ? 'text-purple-600' : 'text-gray-400'}">${badges[index] || `#${index + 1}`}</span>
                                <div>
                                    <h4 class="text-xl font-bold">${user.name}</h4>
                                    <p class="text-gray-600 text-sm">${user.problemsPosted} probl√®mes ‚Ä¢ ${user.problemsResolved} r√©solus</p>
                                </div>
                            </div>
                            <div class="text-3xl font-black text-purple-600">${user.points} pts</div>
                        </div>
                    `;
                }).join('');
            },
            
            setupEventListeners() {
                document.getElementById('start-btn').addEventListener('click', () => this.showMainApp());
                document.getElementById('logo').addEventListener('click', () => this.showMainApp());
                document.getElementById('leaderboard-btn').addEventListener('click', () => this.showLeaderboard());
                document.getElementById('add-problem-btn').addEventListener('click', () => this.openAddProblemModal());
                document.getElementById('close-modal').addEventListener('click', () => this.closeAddProblemModal());
                
                // Filters
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active', 'bg-purple-600', 'text-white'));
                        btn.classList.add('active', 'bg-purple-600', 'text-white');
                        this.currentFilter = btn.dataset.filter;
                        this.renderProblems();
                        this.renderMapMarkers();
                    });
                });
                
                // Form
                document.getElementById('problem-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.submitProblem();
                });
            },
            
            openAddProblemModal() {
                document.getElementById('add-problem-modal').classList.remove('hidden');
                
                // Init mini map
                setTimeout(() => {
                    if (!this.miniMap) {
                        this.miniMap = new google.maps.Map(document.getElementById('mini-map'), {
                            center: this.selectedLocation,
                            zoom: 15
                        });
                        
                        const marker = new google.maps.Marker({
                            position: this.selectedLocation,
                            map: this.miniMap,
                            draggable: true
                        });
                        
                        this.miniMap.addListener('click', (e) => {
                            marker.setPosition(e.latLng);
                            this.selectedLocation = { lat: e.latLng.lat(), lng: e.latLng.lng() };
                        });
                        
                        marker.addListener('dragend', (e) => {
                            this.selectedLocation = { lat: e.latLng.lat(), lng: e.latLng.lng() };
                        });
                    }
                }, 100);
            },
            
            closeAddProblemModal() {
                document.getElementById('add-problem-modal').classList.add('hidden');
                document.getElementById('problem-form').reset();
            },
            
            submitProblem() {
                // Check for duplicates within 50m
                const nearby = DB.problems.filter(p => {
                    const distance = this.calculateDistance(p.lat, p.lng, this.selectedLocation.lat, this.selectedLocation.lng);
                    return distance < 0.05; // 50 meters
                });
                
                if (nearby.length > 0) {
                    if (!confirm('Un probl√®me similaire existe √† proximit√©. Voulez-vous quand m√™me poster ?')) {
                        return;
                    }
                }
                
                // Simulate payment
                if (!confirm('Payer 1‚Ç¨ pour publier ce probl√®me ?')) {
                    return;
                }
                
                const newProblem = {
                    id: Date.now(),
                    category: document.getElementById('problem-category').value,
                    description: document.getElementById('problem-description').value,
                    address: document.getElementById('problem-address').value || 'Localisation manuelle',
                    lat: this.selectedLocation.lat,
                    lng: this.selectedLocation.lng,
                    photo: null, // Would upload to Cloudinary in real app
                    userId: DB.currentUser.id,
                    status: 'signale',
                    votes: 1,
                    timestamp: Date.now(),
                    comments: []
                };
                
                DB.problems.push(newProblem);
                DB.currentUser.problemsPosted++;
                DB.currentUser.points += 10;
                DB.save();
                
                this.closeAddProblemModal();
                this.renderProblems();
                this.renderMapMarkers();
                this.updateUserStats();
                
                alert('‚úÖ Probl√®me publi√© avec succ√®s ! +10 points');
            },
            
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
        };

        // Initialize app
        App.init();
    </script>

</body>
</html>